{"componentChunkName":"component---src-templates-blog-post-js","path":"/imgprogress/","result":{"data":{"site":{"siteMetadata":{"title":"Ian Chu","author":"Ian Chu","siteUrl":"https://ianccy.com","social":{"facebook":"chu1228"}}},"markdownRemark":{"id":"efd6ab90-f695-5e8d-821e-99ff5d4fcdf0","fields":{"slug":"/2018-10-imgprogress/"},"headings":[{"value":"申請 imgur api key","id":null,"depth":2},{"value":"傳統 input 上傳","id":null,"depth":2},{"value":"上傳檔案 progress bar","id":null,"depth":2},{"value":"拖拉上傳檔案","id":null,"depth":2},{"value":"外部檔案拖拉","id":null,"depth":3},{"value":"頁面完成","id":null,"depth":2}],"excerpt":"最近剛好要使用圖片上傳的功能，但因為資源較少，所以考慮用網路上的 image api 服務，稍微研究後選擇 imgur 的服務。以前拖拉上傳，都是用套件處理掉，剛好來研究一下如何處理拖拉上傳圖片，附加進度條功能。 我們需要取得 imgur api，再來使用 input 處理上傳檔案，檔案串接上傳 imgur api…","html":"<p>最近剛好要使用圖片上傳的功能，但因為資源較少，所以考慮用網路上的 image api 服務，稍微研究後選擇 imgur 的服務。以前拖拉上傳，都是用套件處理掉，剛好來研究一下如何處理拖拉上傳圖片，附加進度條功能。</p>\n<p>我們需要取得 imgur api，再來使用 input 處理上傳檔案，檔案串接上傳 imgur api，在處理 drag and drop 拖拉上傳檔案，完成後也要串接 imgur api。</p>\n<p>完成頁面: <a href=\"https://test.ianccy.com/imgur/\" title=\"Drop file demo\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Drop upload demo</a></p>\n<!--- ![dragupload](../images/dragupload.png \"dragupload\") --->\n<h2>申請 imgur api key</h2>\n<p>首先進入 imgur 申請帳號登入，再點選下方的連結，申請屬於自己的 Client ID。後面 call api 會需要使用。</p>\n<p><a href=\"https://api.imgur.com/oauth2/addclient\" title=\"imgur Register an Application\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">imgur Register an Application</a></p>\n<p>查看 imgur\b 提供的 restful api post image，需要帶的有 header client ID，body 則需要有格式\n<code>image</code> A binary file, base64 data, URL for image.限制 10MB 以下，其他則是選填 album(optional)、title、description、name、type。</p>\n<p><a href=\"https://apidocs.imgur.com/#c85c9dfc-7487-4de2-9ecd-66f727cf3139\" title=\"imgur upload api post\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">imgur upload api post</a></p>\n<ul>\n<li>imgur jquery ajax sample</li>\n</ul>\n<pre><code class=\"language-javascript\">var form = new FormData();\nform.append('image', 'R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7');\n\nvar settings = {\n    async: true,\n    crossDomain: true,\n    url: 'https://api.imgur.com/3/image',\n    method: 'POST',\n    headers: {\n        Authorization: 'Client-ID {{clientId}}'\n    },\n    processData: false,\n    contentType: false,\n    mimeType: 'multipart/form-data',\n    data: form\n};\n\n$.ajax(settings).done(function(response) {\n    console.log(response);\n});\n</code></pre>\n<h2>傳統 input 上傳</h2>\n<p>先簡易的傳統的點擊 input 上傳檔案，首先創建 input tag，type 選擇 file，再來監聽這個 input 有沒有變化，如果他有變化的話，代表獲取到檔案上傳，我們就要轉出這個檔案。</p>\n<p>對了，官網範例是用 jquery ajax，為了方便我們直接拿來用，記得要引入 jquery library。</p>\n<pre><code class=\"language-javascript\">...\n&#x3C;body>\n  &#x3C;input type=\"file\" accept=\"image/*\" id=\"imageUpload\" />\n  &#x3C;img id=\"imagePreview\">\n  &#x3C;script>\n    // listen input change call handleFiles\n    document.querySelector('#imageUpload').addEventListener('change',handleFiles);\n\n    function handleFiles() {\n      // get input files object\n      var fileList = this.files;\n      console.log(fileList);\n      if (this.files[0]) {\n        // call ajax\n        upload(this.files[0]);\n      }\n    }\n...\n</code></pre>\n<p>接到檔案後，直接用官網的 sample，調用 ajax post api，headers 帶 Authorization 用產生的 client id，以檔案作為參數。</p>\n<p>完成上傳後，api 會回傳 json 的 string type，所以接到 api 回傳後，要用 JSON.parse 轉成 json type，再取出 link 圖片的網址。這樣就完成了 imgur 的 api 串接。</p>\n<pre><code class=\"language-javascript\">...\n    function upload(data) {\n      var form = new FormData();\n      form.append(\"image\", data);\n\n      var settings = {\n        \"async\": true,\n        \"crossDomain\": true,\n        \"url\": \"https://api.imgur.com/3/image\",\n        \"method\": \"POST\",\n        \"headers\": {\n          \"Authorization\": \"Client-ID {{clientId}}\"\n        },\n        \"processData\": false,\n        \"contentType\": false,\n        \"mimeType\": \"multipart/form-data\",\n        \"data\": form\n      }\n\n      $.ajax(settings).done(function (response) {\n        // get respon string type json\n        var res = JSON.parse(response);\n        console.log(res.data.link);\n        document.getElementById(\"imagePreview\").src = res.data.link;\n      });\n    }\n  &#x3C;/script>\n&#x3C;/body>\n</code></pre>\n<ul>\n<li>input upload imgur demo</li>\n</ul>\n<iframe src=\"https://test.ianccy.com/imgur/try.html\" width=\"100%\" height=\"430\"></iframe>\n<h2>上傳檔案 progress bar</h2>\n<p>製作上傳進度條，就需要監聽上傳檔案的進度，在 jquey ajax 在增加 option xhr，延展 jquery 具有 xhr 特性，在使用 xhr 監聽 upload 事件，取得目前上傳檔案的 size，在除以整個檔案後取的比例，再將這個比例帶進 progress bar value，這樣就完成了上傳進度條。</p>\n<p>提醒 fetch 無法使用進度條監聽事件，axios、原生 xmlhttprequest 都有方法實作進度條。</p>\n<p>實作方法 : <a href=\"https://github.com/axios/axios#request-config\" title=\"axios onUploadProgress\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">axios onUploadProgress</a>、<a href=\"https://developer.mozilla.org/zh-TW/docs/Web/API/XMLHttpRequest/Using_XMLHttpRequest#%E7%9B%A3%E8%A6%96%E9%80%B2%E5%BA%A6\" title=\"xmlhttprequest mdn progress bar\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">xmlhttprequest mdn progress bar</a></p>\n<pre><code class=\"language-javascript\">  // add progress bar element\n  &#x3C;progress id=\"progress\" style=\"display:none\" value=\"0\" max=\"100\">&#x3C;/progress>\n  &#x3C;img id=\"imagePreview\" onload=\"hideProgress()\">\n...\n        \"mimeType\": \"multipart/form-data\",\n        \"data\": form,\n        // add xhr to extend ajax\n        \"xhr\": function() {\n            var myXhr = $.ajaxSettings.xhr();\n            if(myXhr.upload){\n                myXhr.upload.addEventListener('progress',progress, false);\n            }\n            return myXhr;\n        },\n...\nfunction progress(e){\n  if(e.lengthComputable){\n    var length = e.total;\n    var current = e.loaded;\n    var progress = document.getElementById('progress');\n\n    var percent = Math.floor((current * 100)/length);\n    progress.value = percent;\n    if (progress.style.display !== 'block'){\n      progress.style.display = 'block';\n    }\n  }\n }\n function hideProgress(){\n    document.getElementById('progress').style.display = 'none';\n }\n</code></pre>\n<ul>\n<li>upload progress version</li>\n</ul>\n<iframe src=\"https://test.ianccy.com/imgur/try2.html\" width=\"100%\" height=\"450\"></iframe>\n<h2>拖拉上傳檔案</h2>\n<p>這邊會是技術比較複雜的部分，一般網頁開發比較少用到 drag，首先要了解拖拉物件，會觸發哪些 event，拖拉過程怎麼帶資料互動，</p>\n<p>稍微測試每個事件觸發點，當我開始拖拉一個物件，會先觸發 dragstart => drag => dragenter / dragover / dragleave / dragexit => drop => dropend，也就是說拖拉物件到放置另一個區塊，會觸發 drop、dropend，其中 drop 會再被放置到有效區塊才會觸發，而且 dragend 無法以外部拖拉檔案觸發，所以我們只要監聽 drop 就好了。</p>\n<ul>\n<li>HTML drag API</li>\n</ul>\n<pre><code class=\"language-javascript\">drag 於一個元素或文字選取區塊被拖曳時觸發。\ndragend 於拖曳操作結束時觸發（如放開滑鼠按鍵或按下鍵盤的 escape 鍵。\ndragenter 於一個元素或文字選取區塊被拖曳移動進入一個有效的放置目標時觸發。\ndragexit  當一個元素不再是被選取中的拖曳元素時觸發。\ndragleave 於一個元素或文字選取區塊被拖曳移動離開一個有效的放置目標時觸發。\ndragover  於一個元素或文字選取區塊被拖曳移動經過一個有效的放置目標時觸發\ndragstart 於使用者開始拖曳一個元素或文字選取區塊時觸發。\ndrop 於一個元素或文字選取區塊被放置至一個有效的放置目標時觸發。\n\n注意：dragstart 與 dragend 事件，在把檔案從作業系統拖放到瀏覽器時，並不會觸發。\n</code></pre>\n<p>drag 文件: <a href=\"https://developer.mozilla.org/zh-TW/docs/Web/API/HTML_Drag_and_Drop_API\" title=\"MDN HTML Drag_and_Drop_API\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">MDN HTML Drag<em>and</em>Drop_API</a></p>\n<ul>\n<li>MDN drag element demo</li>\n</ul>\n<iframe src=\"//codepen.io/chu1228/embed/mzoXyR/?height=265&theme-id=0&default-tab=result\" width=\"100%\" height=\"250\"></iframe>\n<h3>外部檔案拖拉</h3>\n<p>如果是外部檔案拖拉進的話，依序觸發 dragenter => dragover => drop，這幾個動作要取消預設的事件 event.preventDefault()，防止拖拉開啟檔案。可以用 event.dataTransfer.files 來接受拖拉的檔案。</p>\n<p>下面範例用 FileReader 來轉換檔案成 base64 格式，在打印到 img src 上顯示圖片。</p>\n<pre><code class=\"language-javascript\">&#x3C;div id=\"dragZone\">\n&#x3C;img src=\"https://fakeimg.pl/450x100/?text=Drop_your_Image\">\n&#x3C;/div>\n&#x3C;div id=\"fileText\">&#x3C;/div>\n&#x3C;img src=\"\" id=\"fileImg\" />\n\n&#x3C;script>\nvar dragZone = document.getElementById('dragZone');\nvar fileText = document.getElementById('fileText');\nvar fileImg = document.getElementById('fileImg');\n// cancel default event\ndragZone.addEventListener('dragover',function(e){\n  e.preventDefault();\n  console.log('dragover')\n});\ndragZone.addEventListener('drop',function(e){\n  // cancel default event\n  e.preventDefault();\n  if(e.dataTransfer.files.length > 1){\n    alert('僅支援單一檔案');\n    return;\n  }\n  var file = e.dataTransfer.files[0];\n  if(file.type.indexOf('image') === -1){\n    alert('僅支援圖片格式喔');\n    return;\n  }\n  fileText.innerText = file.name;\n  // export file as base64\n  var reader = new FileReader();\n   reader.readAsDataURL(file);\n   reader.onload = function () {\n     fileImg.src = reader.result\n   };\n});\n&#x3C;/script>\n</code></pre>\n<iframe src=\"https://codepen.io/chu1228/embed/MPxrdq/?height=265&theme-id=0&default-tab=result\" width=\"100%\" height=\"500\"></iframe>\n<script async src=\"https://static.codepen.io/assets/embed/ei.js\"></script>\n<p>這樣就幾乎完成了。我們只要把上面的 drop 獲取檔案，一起與 ajax 呼叫，就支援拖拉上傳檔案了。</p>\n<p>首先增加包覆的 div，隱藏掉傳統的 input 按鈕，讓外層的區塊點擊觸發點擊 input。再增加上事件監聽，主要依靠 drop 監聽，當獲取檔案時，調用 ajax 傳輸資料。</p>\n<ul>\n<li>修改先前檔案</li>\n</ul>\n<pre><code class=\"language-javascript\">  // add container zone and hide input\n  &#x3C;div id=\"dragZone\">\n    拖拉上傳 Drop Upload\n    &#x3C;input type=\"file\" accept=\"image/*\" id=\"imageUpload\" />\n    &#x3C;progress id=\"progress\" style=\"display:none\" value=\"0\" max=\"100\">&#x3C;/progress>\n  &#x3C;/div>\n...\nvar dragZone = document.getElementById('dragZone');\n\n// add listener click dropzone trigger click input\ndragZone.addEventListener('click',function(e){\n  document.getElementById('imageUpload').click();\n})\ndragZone.addEventListener('dragover',function(e){\n  e.preventDefault();\n});\n\ndragZone.addEventListener('drop',function(e){\n...\n  if(file.type.indexOf('image') === -1){\n    alert('僅支援圖片格式喔');\n     return;\n  }\n  // get file call ajax\n  upload(file);\n});\n</code></pre>\n<h2>頁面完成</h2>\n<p><a href=\"https://test.ianccy.com/imgur/\" title=\"Drop file demo\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Drop file demo</a></p>\n<iframe src=\"https://test.ianccy.com/imgur/\" width=\"100%\" height=\"500\"></iframe>\n<p>成功!!這樣就完成拖拉上傳了。</p>\n<p>實際寫一遍會發現其實並沒有太艱難，只是有滿多小細節要處理，包含拖拉事件、串接 api 檔案格式、進度條處理等等。這邊還沒寫邏輯還有圖片寬度高度、size 判斷等等。但擔心繼續寫下去會太長，等下一篇再來處理這些小細節吧。</p>","frontmatter":{"title":"Upload progress bar drag&drop 圖片拖拉上傳進度條","date":"October 27, 2018","description":"首先申請imgur api，再處理input獲取檔案，獲取後串接api，另外針對拖拉要處理事件，要利用dataTransfer獲取檔案，再串接到api，另外針對ajax監聽，製作出進度條。","categories":"javascript","tags":["javascript"],"thumbnail":{"childImageSharp":{"fluid":{"base64":"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAANCAIAAAAmMtkJAAAACXBIWXMAAAsSAAALEgHS3X78AAAB0klEQVQoz2P4jw38A4P/hAADHm1Axl8kgGkcimagipcvXgLRhw8f37179+nT548fP0EQUOT79x8QE3HaDAF/fv/++/s3sc6GmHfn5p1DO/Y8evzi1///P/78+/T918evPz99+/n5288v339///XnL6rLoZr//vkDJNdOmVJvb7SyMHF+V//6zQeW7rqwZu+F7ceuHblw9+KdZ3efvfv5+w82m/+CRC+vnrcsxOJMdcjCALPJuVmLd12Yt+H4nLVH5q47unDT8cWbj7948xHZ2yiaLyyZPtvLaEOy+85k++W5Mav3XZi19siCFbvnr9o7c+mu2Sv3Pn/9AYtmiLMXTZ5aZKG3LMJpvpfRnFCHxikrJ686OGneptVbj+4+dH7/iSvvP30Fa0Z19h+w5vYJs2RVTCKd3WtsDWf7WwfEFU9de3jvxYc7T98+cPHB9jN3X338hlPzxOkL5XTslYxcdfXtMlxcXAPTwnOaTt97c+DKk8V7LtW2zXp4+w42Z//9CyQXL18XlVYRmZQXlVaWmF+fVNAUkVq25+ydnafu9C/cXJFV8PzmdXAA/cWSSH7//vXrNxD8AeE/f4DsHz9+/Pz16/vPX1++fP3y7cfvvyjxDAA7y5+farHIEAAAAABJRU5ErkJggg==","aspectRatio":1.5315315315315314,"src":"/static/779e17215a7282b0a75020b8f77faf25/ee604/dragupload.png","srcSet":"/static/779e17215a7282b0a75020b8f77faf25/c972b/dragupload.png 340w,\n/static/779e17215a7282b0a75020b8f77faf25/27625/dragupload.png 680w,\n/static/779e17215a7282b0a75020b8f77faf25/ee604/dragupload.png 800w","sizes":"(max-width: 800px) 100vw, 800px"}}}},"timeToRead":6,"parent":{"__typename":"File","modifiedTime":"2021-05-16T08:19:40.139Z"}}},"pageContext":{"slug":"/2018-10-imgprogress/","previous":{"fields":{"slug":"/2018-10-tagteach/"},"frontmatter":{"title":"Google Tag Manager(gtm)教學 觸發、代碼、變數設定介紹","tags":["tag_manager","google_analytics"]}},"next":{"fields":{"slug":"/2018-11-reactportal/"},"frontmatter":{"title":"React Portals render component anywhere example","tags":["react.js"]}}}},"staticQueryHashes":["1481458783","63159454"]}