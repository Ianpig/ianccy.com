{"componentChunkName":"component---src-templates-blog-post-js","path":"/nodejsapi/","result":{"data":{"site":{"siteMetadata":{"title":"Ian Chu","author":"Ian Chu","siteUrl":"https://ianccy.com","social":{"facebook":"chu1228"}}},"markdownRemark":{"id":"2b6a6665-f9df-5520-b871-e6e794beb61d","fields":{"slug":"/2018-10-nodejsapi/"},"headings":[{"value":"安裝 Node.js express","id":null,"depth":2},{"value":"建立 nodejs server","id":null,"depth":2},{"value":"/index.js","id":null,"depth":4},{"value":"index.html","id":null,"depth":4},{"value":"建立 mLab account 創建 mongoDB","id":null,"depth":2},{"value":"POST Api 創建資料","id":null,"depth":2},{"value":"index.js","id":null,"depth":4},{"value":"javascript fetch post","id":null,"depth":4},{"value":"Get Api 取得資料","id":null,"depth":2},{"value":"index.js","id":null,"depth":4},{"value":"Delete Api 取得資料","id":null,"depth":2},{"value":"Update Api 更新資料","id":null,"depth":2},{"value":"localhost api file","id":null,"depth":4},{"value":"部署到 Heroku","id":null,"depth":2},{"value":"heroku deploy 流程","id":null,"depth":3},{"value":"實作頁面","id":null,"depth":3},{"value":"完整程式碼","id":null,"depth":3}],"excerpt":"前端不斷的演進，更講求畫面快速變化，跳脫傳統傳送資料方式，漸漸改為用 javascript 連接，所以，server 端就負責建立 api，透過串接 api 處理資料。 關於 \b\bApi，\b 就有所謂的 RESTful (Representational State Transfer)，RESTful…","html":"<p>前端不斷的演進，更講求畫面快速變化，跳脫傳統傳送資料方式，漸漸改為用 javascript 連接，所以，server 端就負責建立 api，透過串接 api 處理資料。</p>\n<p>關於 \b\bApi，\b 就有所謂的 RESTful (Representational State Transfer)，RESTful 是某種設計架構的稱呼，方便、有彈性的傳輸資料。後面來會用 node.js 搭配 express 架構 RESTful Api，部署到 server 上，建立一個簡單的留言板。</p>\n<p><a href=\"https://work.ianccy.com/commentboard/\" title=\"Demo comment board\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Demo comment board</a>\nFree Heroku 會 sleep，太慢請 reload</p>\n<!--- ![node restful api](../images/nodeapi.png \"node restful api\") --->\n<h2>安裝 Node.js express</h2>\n<p>首先先創建資料夾，npm init 安裝 package.json。</p>\n<pre><code class=\"language-javascript\">// create file\nmkdir nodeapi\ncd nodeapi\n// install package.json\nnpm init\n// install express\nnpm install --save express\n</code></pre>\n<p>接下來要開始建立 node.js\b server</p>\n<pre><code class=\"language-javascript\">// open package.json &#x26; add npm start\n...\n\b  \"scripts\": {\n    \"start\": \"node index.js\",\n    \"test\": \"echo \\\"Error: no test specified\\\" &#x26;&#x26; exit 1\"\n  },\n...\n\n// create index.js\ntouch index.js\n</code></pre>\n<h2>建立 nodejs server</h2>\n<p>\b\b 以 index.js 作為 node.js server 的起始點，首先引入 express，執行使用 express，這邊先設定好 Port 是 3000，再來建立 get 的 route，路徑是/comments。儲存後執行 npm start，在網址輸入 <a href=\"http://localhost:3000/%EF%BC%8C%E9%80%99%E6%99%82%E5%80%99%E6%9C%83%E7%9C%8B%E5%88%B0%E7%95%AB%E9%9D%A2%E9%A1%AF%E7%A4%BA\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">http://localhost:3000/，這時候會看到畫面顯示</a> Hello world。</p>\n<h4>/index.js</h4>\n<pre><code class=\"language-javascript\">const express = require('express');\nconst app = express();\n\nconst port = 3000;\n\napp.get('/', (req, res) => {\n    res.sendFile(__dirname + '/index.html');\n});\n\napp.listen(port, function() {\n    console.log(`server start on http://localhost:${port}, port`);\n});\n</code></pre>\n<h4>index.html</h4>\n<pre><code class=\"language-javascript\">&#x3C;!DOCTYPE html>\n&#x3C;html lang=\"en\">\n&#x3C;head>\n  &#x3C;meta charset=\"UTF-8\">\n  &#x3C;meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\n  &#x3C;meta http-equiv=\"X-UA-Compatible\" content=\"ie=edge\">\n  &#x3C;title>Document&#x3C;/title>\n&#x3C;/head>\n&#x3C;body>\n  &#x3C;h1>Hello!!&#x3C;/h1>\n&#x3C;/body>\n&#x3C;/html>\n</code></pre>\n<h2>建立 mLab account 創建 mongoDB</h2>\n<p>因為我想試試看串接 mongoDB，這邊選用 mLab 來管理 mongoDB，流程大概是進入 mlab 網站，建立帳戶，再來創建 db，點擊建立 User，設定帳號、密碼、權限。</p>\n<p>這邊雖然看似簡單但非常麻煩。</p>\n<p><a href=\"https://docs.mlab.com/\" title=\"mlab 建立mongoDB教學\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">mlab 建立 mongoDB 教學</a></p>\n<p>記得要 create user，後面會依靠這個 username 跟 password 來串接 mongoDB，我因為打錯 dbName，顯示 <em>MongoError: not authorized on dbname to execute command</em>，大概卡了 40 分鐘...。</p>\n<p><img src=\"../images/createmlab.png\" alt=\"createmlab\" title=\"createmlab\"></p>\n<p>首先安裝 mongodb。</p>\n<pre><code class=\"language-javascript\">npm install --save mongodb\n</code></pre>\n<p>index.js 增加內容</p>\n<pre><code class=\"language-javascript\">// modify index.js\n...\nconst MongoClient = require('mongodb').MongoClient;\n\nconst url = 'mongodb://ian:PASSWORD@ds131323.mlab.com:31323/ian-test';\n\nMongoClient.connect(url, function(err, db) {\n    if (err) throw err;\n    const dbo = db.db(\"ian-test\");\n    const myobj = { name: \"john\", time: \"2018/10/13/00:58\", content: \"hello, good evening\" };\n    dbo.collection(\"comments\").insertOne(myobj, function(err, res) {\n      if (err) throw err;\n      console.log(\"1 document inserted\");\n      db.close();\n    });\n});\n...\n</code></pre>\n<p>修改完成後輸入 npm start，如果沒出現 error 就可以打開 collection 觀看，會增加一個 comments 的 collection，點開 comments 會發現剛剛 myobj 資料在裡面。這邊是建立資料邏輯，在 RESTful 會用到 Create，剩下更新 PUT、刪除 Delete、讀取 Get 後面再寫上。</p>\n<p><a href=\"https://www.w3schools.com/nodejs/nodejs_mongodb_createcollection.asp\" title=\"w3c mongoDB 語法教學\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">w3c mongoDB 語法教學</a></p>\n<p><img src=\"../images/mlabData.png\" alt=\"mlabData\" title=\"mlabData\"></p>\n<h2>POST Api 創建資料</h2>\n<p>這邊要下載 body-parser 插件，要對資料格式處理，這邊要使用到是 JSON data。在 index.js 引入 body-parser，使用 bodyParser 對資料轉型別成 json type，建立 post 的 route，我們命名路徑為/comments。</p>\n<pre><code class=\"language-javascript\">npm install body-parser --save\n</code></pre>\n<h4>index.js</h4>\n<pre><code class=\"language-javascript\">...\nconst bodyParser = require('body-parser');\n\napp.use(bodyParser.json());\n\napp.post('/comments', (req, res) => {\n    console.log(req.body);      // your JSON\n    db.collection('comments').save(req.body, (err, result) => {\n        if (err) return console.log(err)\n        console.log('saved to database')\n        res.send(req.body);\n    });\n})\n\n// modify app.listen(3000, () => {});\nMongoClient.connect(url, (err, client) => {\n    if (err) return console.log(err)\n    db = client.db('ian-test')\n    app.listen(port, () => {\n        console.log('listening on 3000')\n    })\n})\n...\n</code></pre>\n<p>修改完成後重新 npm start，打開 localhost:3000，打開瀏覽器 devtool，在 console.log 貼上這段 fetch post，成功的話會接收到回傳資料，哇嗚，這樣就完成了儲存的 API!!</p>\n<h4>javascript fetch post</h4>\n<pre><code class=\"language-javascript\">fetch('http://localhost:3000/comments', {\n    method: 'post',\n    headers: {\n        Accept: 'application/json, text/plain, */*',\n        'Content-Type': 'application/json'\n    },\n    body: JSON.stringify({\n        name: 'mikessss',\n        time: '2018/10/13-02:33:01',\n        content: 'ggggggg.'\n    })\n})\n    .then(res => res.json())\n    .then(res => console.log(res));\n</code></pre>\n<h2>Get Api 取得資料</h2>\n<p>我們前面成功的建立了儲存的 api，之後的邏輯都大同小異，接收 request，再依照請求方式跟 mongoDB 連接資料。我們這邊的 get api 會拿整個 comments 的資料，如果看不懂 collection.find()，可以看一下 w3c 的 mongoDB 語法教學，非常簡單易懂。</p>\n<p>增加完成後，一樣重新啟動，再來載入 <a href=\"http://localhost:3000/comments%EF%BC%8C%E5%B0%B1%E7%9C%8B%E5%88%B0%E6%88%91%E5%80%91%E5%89%9B%E5%89%9B%E5%84%B2%E5%AD%98%E9%80%B2%E5%8E%BB%E7%9A%84%E6%89%80%E6%9C%89%E8%B3%87%E6%96%99%E4%BA%86%E3%80%82%1C\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">http://localhost:3000/comments，就看到我們剛剛儲存進去的所有資料了。\u001c</a></p>\n<h4>index.js</h4>\n<pre><code class=\"language-javascript\">...\n\napp.get('/comments', (req, res) => {\n  db.collection('comments').find().toArray((err, result) => {\n    if (err) return console.log(err)\n    res.send({data: result})\n  })\n})\n\n...\n</code></pre>\n<h2>Delete Api 取得資料</h2>\n<p>這邊就建立一個 delete 的網址路徑，我們利用網址:id 來帶參數，方便我們好維運 api。mongoDB 刪除用的是 remove function，假設要用 mongoDB 預設的_id 當作查詢刪除，會多需要使用 ObjectID 處理 value，但如果你是自己用其他物件來查詢，就不用使用 ObjectID\b。</p>\n<p>這邊就不提供 fetch 測試了，推薦使用 postman 測試請求方式，又簡單又快又方便。</p>\n<p><a href=\"https://chrome.google.com/webstore/detail/postman/fhbjgbiflinjbdggehcddcbncdddomop\" title=\"postman chrome tool\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">postman chrome tool</a></p>\n<pre><code class=\"language-javascript\">const ObjectID = require('mongodb').ObjectID;\n\napp.delete('/comments/:id', (req, res) => {\n    // use _id need use ObjectID(value)\n    const obj = { _id: ObjectID(req.params.id) };\n    db.collection('comments').remove(obj, function(err, obj) {\n        if (err) throw err;\n        console.log('1 document deleted');\n        res.send('delete success');\n    });\n});\n</code></pre>\n<h2>Update Api 更新資料</h2>\n<p>建立 put 的 route，使用 updateOne 來更新資料，前面兩個參數要帶查詢、更新資料。</p>\n<p>這樣就完成了 CRUD 的 API 了，下個步驟會建立簡單的畫面，在部署到 server 上，讓我們可以在畫面操作讀取、建立、更新、刪除資料。</p>\n<pre><code class=\"language-javascripts\">app.put('/comments/:id', (req, res) => {\n    console.log(req.params.id, req.body);\n    const newvalues = {$set: req.body};\n    const obj = {_id: ObjectID(req.params.id)};\n    db.collection(\"comments\").updateOne(obj, newvalues, function(err, obj) {\n        if (err) throw err;\n        console.log(\"1 document update\");\n        res.send('update success');\n    });\n})\n</code></pre>\n<h4>localhost api file</h4>\n<p><a href=\"https://github.com/Ianpig/node_api_comments/tree/831ddadd7cbde2f39f34adca1625e50e97a2e1c9\" title=\"github 程式碼\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">github 程式碼</a></p>\n<h2>部署到 Heroku</h2>\n<p>部署到 server 上，讓我們未來方便直接串接 api，提醒一下要到 heroku 設定 mLab 的連線，否則會連不到 mongoDB。\n(這邊我也卡了 30 分鐘...，安裝 addons 也沒用，是執行下面的 command 才 run 起來)</p>\n<pre><code class=\"language-javascript\">heroku config:set PROD_MONGODB=mongodb://dbname:password@ds131323.mlab.com:31323/ian-test\n</code></pre>\n<p><a href=\"https://devcenter.heroku.com/articles/mongolab#connecting-to-existing-mlab-deployments-from-heroku\" title=\"heroku mLab setting\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">heroku mLab setting</a></p>\n<h3>heroku deploy 流程</h3>\n<pre><code class=\"language-javascript\">//login account\nheroku login\n\n//use git\ngit init\ngit add .\ngit commit -m \"init node\"\n\n// create heroku repo\nheroku create\n\n// push remote\ngit push heroku master\n\nheroku ps:scale web=1\n\nheroku open\n</code></pre>\n<p>再來載入 /comments 路徑，<a href=\"https://thawing-stream-74537.herokuapp.com/comments\" title=\"pathname/comments\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">pathname/comments</a>，看到 mongoDB 的資料拉!</p>\n<p><img src=\"../images/apidata.png\" alt=\"node api data\" title=\"node api data \"></p>\n<p>大功告成，接下來就處理好前端串接，畫面互動就可以了。</p>\n<h3>實作頁面</h3>\n<p><a href=\"https://work.ianccy.com/commentboard/\" title=\"Demo comment board\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Demo comment board</a></p>\n<h3>完整程式碼</h3>\n<p><a href=\"https://github.com/Ianpig/node_api_comments\" title=\"github 程式碼\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">github 程式碼</a></p>\n<p>有問題歡迎詢問，感謝閱讀！！</p>","frontmatter":{"title":"Node.js Express MongoDB RESTful Api 留言板實作教學","date":"October 11, 2018","description":"RESTful是某種設計架構的稱呼，方便、有彈性的傳輸資料。這邊會用node.js搭配express架構RESTful Api，資料會使用mongoDB，部署到server上，建立一個簡單的留言板。","categories":"javascript","tags":["node.js"],"thumbnail":{"childImageSharp":{"fluid":{"base64":"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAMCAIAAADtbgqsAAAACXBIWXMAAAsSAAALEgHS3X78AAACCUlEQVQoz2P49x8nwCMFAQx/san7++/ftju3HZavbL1y6y9Y9i+yof+ACEQwlN16B1aNYtunHz8qt25JmjW97cTJB99+/vj7791vqPYfP/79/AmzuWbZg9Nvvk9/8hliJNDOv3//gsxFseofRBzIvnz+xd6VDw8sOjstaRnDIu2Vvj4zAxr2Ljr9Gk3PH7CePzCz/vz5AySPnjwc7GefEmqdGeXKMIEhr1qyuF2vf0H1nhs3r2/ZvGXXrl3Hjh27ePHitm3b1q1bt2XLloMHDly4cGHjhnWHjp68cmjN5Hi285tTX705y7CE1b6a3yOBwWGSd9W379+uXb164/qNq1eu3L9///nz57du3nz2FASeP3/2+NHDN59/fD63+ev8zP+/voH8vJZLspJfPZRBcZlPPsR7uKMOJPXzxc3f9078A/H+MuyXEm2S4/Nm4F9gn/zm9t0P1268u3bt9+1rb25ef3Xj+scb137dvv7n3rX/v77/+/Xj/9+/yNHKcE2W92RP4SxZv5kMxnk8Ek2cPEe5uR7LcC3g457Bw7OAi/umOOPfBJN/H16DI+MvSiL5VpP4/9/XXwdureLQXszAMY2B6Tk7wwMBhnMSDPu5GA6JM7434P/X0/YP5mwUzf///gYnl/9vmxa8kXK8xSf9SIrrljbD93Spf5k6fxJs/29Y9u/R4//YNAMAIB4+uuVFf2QAAAAASUVORK5CYII=","aspectRatio":1.6666666666666667,"src":"/static/1ed623532b4aa4e991197f6c20908da7/ee604/nodeapi.png","srcSet":"/static/1ed623532b4aa4e991197f6c20908da7/c972b/nodeapi.png 340w,\n/static/1ed623532b4aa4e991197f6c20908da7/27625/nodeapi.png 680w,\n/static/1ed623532b4aa4e991197f6c20908da7/ee604/nodeapi.png 800w","sizes":"(max-width: 800px) 100vw, 800px"}}}},"timeToRead":6,"parent":{"__typename":"File","modifiedTime":"2021-05-16T08:19:40.140Z"}}},"pageContext":{"slug":"/2018-10-nodejsapi/","previous":{"fields":{"slug":"/2018-09-firstinterviewer/"},"frontmatter":{"title":"第一次面試人","tags":["frontend"]}},"next":{"fields":{"slug":"/2018-10-tagteach/"},"frontmatter":{"title":"Google Tag Manager(gtm)教學 觸發、代碼、變數設定介紹","tags":["tag_manager","google_analytics"]}}}},"staticQueryHashes":["1481458783","63159454"]}