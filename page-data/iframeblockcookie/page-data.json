{"componentChunkName":"component---src-templates-blog-post-js","path":"/iframeblockcookie/","result":{"data":{"site":{"siteMetadata":{"title":"Ian Chu","author":"Ian Chu","siteUrl":"https://ianccy.com","social":{"facebook":"chu1228"}}},"markdownRemark":{"id":"3629849c-1f11-52ca-a9f2-17044da7be96","fields":{"slug":"/2019-12-iframeblockcookie/"},"headings":[{"value":"桌機、手機版 登入流程","id":null,"depth":3},{"value":"Block third-party cookie","id":null,"depth":2},{"value":"解決 Block third-party Cookie","id":null,"depth":2},{"value":"頁面無法倒轉情況","id":null,"depth":2},{"value":"心得","id":null,"depth":2}],"excerpt":"來分享個 cookie 相關的內容，是前陣子合作專案測試階段遇到的問題，發生情境是，合作廠商的手機瀏覽器會無法登入會員，主要都是 IOS 用戶。 提一下目前頁面會放置在對方網站上以 iframe 使用，用戶會點擊 iframe 內登入按鈕，轉導頁面，載入對應的登入 line、facebook…","html":"<p>來分享個 cookie 相關的內容，是前陣子合作專案測試階段遇到的問題，發生情境是，合作廠商的手機瀏覽器會無法登入會員，主要都是 IOS 用戶。</p>\n<p>提一下目前頁面會放置在對方網站上以 iframe 使用，用戶會點擊 iframe 內登入按鈕，轉導頁面，載入對應的登入 line、facebook 網頁等等，完成登入。</p>\n<!--- ![block cookie](../images/blockcookie.png \"block cookie\") --->\n<h3>桌機、手機版 登入流程</h3>\n<pre><code class=\"language-javascript\">Desktop:\nwebsite (parent) => click Login => open window (child)\n=> login success => postMessage to parent ( child close )\n=> parent reload => done\n\nMobile:\nwebsite (parent) => click Login\n=> redirect => login success => done\n</code></pre>\n<ul>\n<li>登入流程 (簡易版)\n<img src=\"../images/loginflow.png\" alt=\"login flow\" title=\"login flow\"></li>\n</ul>\n<p>登入是依賴 cookie，cookie 再交由後端驗證登入與否。經由測試後發現這些驗證請求都不會帶有 cookie，也就是說經由登入流程過後，cookie 沒有正確的存取到用戶的瀏覽器上。</p>\n<p>但合作方希望能跳過以上這些步驟，載入頁面時，直接 call 後端取得 token，直接塞入頁面。</p>\n<p>實際測試發現後端有正確建立這個 token，但就是前端 save cookie 那步驟有問題，於是開始轉向思考前端問題。</p>\n<h2>Block third-party cookie</h2>\n<p>IOS 11 開始預設開啟 prevent cross-site tracking 的設定，這會導致第三方 cookie 無法設置，例如 google analytics、facebook pixel 等等，另外也包括了 iframe 內部網頁，這符合我們的情境。</p>\n<p>android 也同樣有這個設定，但目前沒有預設開啟。</p>\n<pre><code class=\"language-javascript\">Privacy by default\nSafari’s key privacy features are enabled by default.\nFor example, in iOS, Intelligent Tracking Prevention\n(shown in Settings as Prevent Cross-Site Tracking)\nis turned on by default. Camera, microphone,\nand location are set to ask for permission before granting access.\n</code></pre>\n<p>官方文件: <a href=\"https://www.apple.com/safari/docs/Safari_White_Paper_Nov_2019.pdf\" title=\"Safari Privacy Overview \" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Safari Privacy Overview </a></p>\n<h2>解決 Block third-party Cookie</h2>\n<p>查了網路後，發現有個方法可以繞過 safari 阻擋 cookie，<code>就是要載入該 domain 並且設定一個 cookie 在該網域上</code>，之後 iframe 就可以設定 cookie 了。</p>\n<p>ps.最新的 safari 13.1 擋掉了這個方法，ooxx...。</p>\n<p>但是在 chrome，就無法這樣處理了，android 實現阻擋的方法不一樣，它是讓 third-party 可以存 cookie，但是無法取出 cookie。</p>\n<p>若要完美處理 Block third-party Cookie 唯一解法就是改用 local Storage 或是 Session Storage，前幾天在 Line Liff 上看到也是用 Session Storage 來處理 token。</p>\n<h2>頁面無法倒轉情況</h2>\n<p>最近桌機 safari 的某個與 cookie 相關功能失效，就是因為 block third-party cookie 導致，那時同事 hotfix 做法非常簡單暴力，就是判斷 safari，直接轉導頁面過去 set cookie，再轉導回來。</p>\n<h2>心得</h2>\n<p>寫這篇是希望有人遇到 cookie 無法設定的問題，提供一些解決的方法。</p>\n<p>另外還有 Web in app 時，也有很多狀態需要確認，每個 app 可能都有不一樣的設定，推薦大家一個 debug 工具，這工具可以會顯示 element、console、network、web storage，可以大量減少手機裝置 debug 的痛苦，web in app 無法連線桌機的 devTool 極高痛苦度。</p>\n<p>工具: <a href=\"https://github.com/Tencent/vConsole\" title=\"Tencent vConsole\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Tencent vConsole</a></p>\n<p>前幾天 google 公告兩年後要全面阻擋第三方 cookie，這對於前端又是很大的考驗，看來未來要開發上，要多思考無法避免成為第三方狀況下，轉而使用 Session Storage、Local Storage。</p>\n<p>感謝閱讀!!</p>","frontmatter":{"title":"阻擋第三方(Block third-party) Cookie，各瀏覽器狀態","date":"December 11, 2019","description":"IOS 11 開始預設開啟 prevent cross-site tracking 的設定，這會導致第三方 cookie 無法設置，若要完美處理 Block third-party Cookie 唯一解法就是改用 local Storage 或是 Session Storage。","categories":"javascript","tags":["javascript"],"thumbnail":{"childImageSharp":{"fluid":{"base64":"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAIAAAA7N+mxAAAACXBIWXMAAAsTAAALEwEAmpwYAAACOElEQVQozw3DaU/aYAAA4H5ZssV5cPV8Syu0hd6IFHS4cWgResHK2xYEBHWiO9wW59zMEt3hliVLlvhlv3c+yYPEYuhDUl2ipAWR54pbgn++sm4x22OCYFBOW9Q7uXI9sI2G2+vvzS7fzM1G89GzUaoGSxqNFGRGlTOxJB5fxtKsmNZqBEqVFKmoqBtPd3G9kcgZ6Kq8pNWAWNzaWGO0DZQvVxv1ev0JItOsnM0+kKpxpW43m7V6q1rZnA89ONxrW27UMk3P2/aDnSjase1ipVzdNgVtMxVH47SIxJPCY0JdpFVBqbge9Cy757j9Hjw7enF2ejLtu2/ns3A4hLPpMXQC24kcR89LyyAf50oIybAcn2GZTFrddG1n0Id+OHZ2zYuT2b+7vzdXH39fX4277X2vNQncYDyAk6mxXqIAw2RFZAHnCQIwHJ8vGhC6UehHnvvq9OX88OBwGO1H4TSAx6PB0TDYHw/mB6PX0wh2mqogVHQNQQFFUCRG07Kudj0r8rt9z/p0/u7P7dfv118+f3j/69vN7c8fV5cXB5NgFPROR2HbboulQlbMIySGp0nAUkBTxL2eNfHdQdf1d82wbcJOK3SdvmPBjhk57dFzZ9y156FvlNZwSQI5AUmlyJUERZIMTdKKICo5SZELlaJRUHRZkES5oCtlVS5KufvrqmZoosLldQIHBM0jGEElCYBhgMTIewmMRAHLsDyJ0wROU2meJhQ6W4gBDjBGkhLQBLrKZlgul2Ly/wHoBImwqOJERQAAAABJRU5ErkJggg==","aspectRatio":2.035928143712575,"src":"/static/1c41405e1cfd8c04bb8410c46e89822a/44ef2/blockcookie.png","srcSet":"/static/1c41405e1cfd8c04bb8410c46e89822a/c972b/blockcookie.png 340w,\n/static/1c41405e1cfd8c04bb8410c46e89822a/27625/blockcookie.png 680w,\n/static/1c41405e1cfd8c04bb8410c46e89822a/44ef2/blockcookie.png 890w","sizes":"(max-width: 890px) 100vw, 890px"}}}},"timeToRead":2,"parent":{"__typename":"File","modifiedTime":"2021-05-16T08:19:40.155Z"}}},"pageContext":{"slug":"/2019-12-iframeblockcookie/","previous":{"fields":{"slug":"/2019-11-reduxdispatch/"},"frontmatter":{"title":"Redux multiple dispatch，batch redux-thunk","tags":["react.js"]}},"next":{"fields":{"slug":"/2020-02-reactpuppeteer/"},"frontmatter":{"title":"Puppeteer End-to-End Test React","tags":["react.js"]}}}},"staticQueryHashes":["1481458783","63159454"]}